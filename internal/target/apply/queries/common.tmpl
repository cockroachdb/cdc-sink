{{- /*gotype: github.com/cockroachdb/cdc-sink/internal/target/apply.templates*/ -}}

{{- /* names produces a comma-separated list of column names: foo, bar, baz*/ -}}
{{- define "names" -}}
    {{- range $idx, $col := . }}
        {{- if $idx -}},{{- end -}}
        {{$col.Name}}
    {{- end -}}
{{- end -}}

{{- /*
params produces a comma-separated list of substitution params tuples:
($1, $2, $3), ($4, $5, $6), ...
*/ -}}
{{- define "params" -}}
    {{- range $pairIdx, $pairs := $.Vars -}}
        {{- if $pairIdx -}},{{- end -}}
        (
        {{- $needsComma := false }}
        {{- range $pair := $pairs -}}
            {{- if $needsComma -}},{{- else -}}{{- $needsComma = true }}{{- end -}}
            ${{- $pair.Index -}}
        {{- end -}}
        )
    {{- end -}}
{{- end -}}

{{- /*
exprs is similar to the param templates, save that it adds explicit
typecasts to each variable produces a comma-separated list of typed
substitution params: ($1::STRING, $2::INT), (...), (...), ...
*/ -}}
{{- define "exprs" -}}
    {{- range $pairIdx, $pairs := $.Vars -}}
        {{- if $pairIdx -}},{{- nl -}}{{- end -}}
        (
        {{- $needsComma := false }}
        {{- range $pair := $pairs -}}
            {{- if $needsComma -}},{{- else -}}{{- $needsComma = true }}{{- end -}}
            {{- if eq $pair.Column.Type "GEOGRAPHY" -}}
                st_geogfromgeojson(${{ $pair.Index }}::JSONB)
            {{- else if eq $pair.Column.Type "GEOMETRY" -}}
                st_geomfromgeojson(${{ $pair.Index }}::JSONB)
            {{- else -}}
                ${{ $pair.Index }}::{{ $pair.Column.Type }}
            {{- end -}}
        {{- end -}}
        )
    {{- end -}}
{{- end -}}

{{- /* join creates a comma-separated list of its input: a, b, c, ... */ -}}
{{- define "join" -}}
    {{- range $idx, $val := . }}
        {{- if $idx -}},{{- end -}}
        {{- $val -}}
    {{- end -}}
{{- end -}}
